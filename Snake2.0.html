<!-- Only the modified JavaScript section is shown below -->
<script>
  // Host Game Loop (Authoritative Simulation)
  function startHostGameLoop() {
    // Ensure food is present in the game state.
    gameStateRef.child('food').once('value', snapshot => {
      if (!snapshot.exists()) {
        gameStateRef.child('food').set(spawnFood());
      }
    });

    // Run the game tick every 100ms.
    setInterval(() => {
      gameStateRef.once('value', snapshot => {
        const state = snapshot.val();
        if (!state) return;
        const players = state.players || {};
        let food = state.food;
        let foodEaten = false;

        // Process each player's snake.
        Object.keys(players).forEach(pid => {
          const player = players[pid];
          if (!player.alive) return;
          let snake = player.snake;
          let dx = player.dx;
          let dy = player.dy;

          // Calculate new head position.
          let head = { x: snake[0].x + dx, y: snake[0].y + dy };

          // Wrap around if head goes off the canvas edges.
          if (head.x < 0) {
            head.x = canvas.width - grid;
          } else if (head.x >= canvas.width) {
            head.x = 0;
          }
          if (head.y < 0) {
            head.y = canvas.height - grid;
          } else if (head.y >= canvas.height) {
            head.y = 0;
          }

          // Check for collisions with any snake segment (self or others).
          Object.keys(players).forEach(otherPid => {
            const otherPlayer = players[otherPid];
            if (otherPlayer.snake) {
              otherPlayer.snake.forEach(segment => {
                if (head.x === segment.x && head.y === segment.y) {
                  player.alive = false;
                }
              });
            }
          });

          // If the player is still alive, update their snake.
          if (player.alive) {
            snake.unshift(head);
            // If the head is on the food, update score and flag food for respawn.
            if (food && head.x === food.x && head.y === food.y) {
              player.score += food.points;
              foodEaten = true;
            } else {
              snake.pop();
            }
            players[pid].snake = snake;
          }
        });

        // If any player ate the food, spawn new food.
        if (foodEaten) {
          food = spawnFood();
        }

        // Update the game state with new player positions and food.
        gameStateRef.update({
          players: players,
          food: food
        });

      });
    }, 100);
  }
</script>
